<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stock Opname Sparepart</title>

<!-- LIBRARY -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
:root{
--primary:#2563eb;--bg:#f1f5f9;--card:#fff;
--success:#16a34a;--danger:#dc2626;--neutral:#64748b;
--border:#e5e7eb;--dark:#1e293b;
}
body{margin:0;font-family:Segoe UI;background:var(--bg);min-height:100vh}
header{background:#fff;padding:16px 24px;box-shadow:0 2px 8px rgba(0,0,0,.05);display:flex;justify-content:space-between;align-items:center}
.container{padding:20px;max-width:1200px;margin:0 auto}
.card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 10px 25px rgba(0,0,0,.05);margin-bottom:20px}

.controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px;align-items:center}
input,button,select{
padding:10px 14px;border-radius:8px;border:1px solid var(--border);
font-size:14px;transition:all .2s
}
input[type="file"]{font-size:12px;padding:8px}
button{cursor:pointer;font-weight:500}
button.primary{background:var(--primary);color:#fff;border:none}
button.danger{background:var(--danger);color:#fff;border:none}
button:hover{opacity:0.9;transform:translateY(-1px)}
button:active{transform:translateY(0)}

/* Table Responsif */
.table-wrapper{overflow-x:auto;border-radius:8px;border:1px solid var(--border)}
table{width:100%;border-collapse:collapse;min-width:600px}
th,td{padding:12px 10px;border-bottom:1px solid var(--border);font-size:14px}
th{background:#f8fafc;font-weight:600;color:var(--dark);position:sticky;top:0}
tr:hover{background:#f8fafc}

.selih{font-weight:600;text-align:center;border-radius:6px;padding:4px;width:100%;display:block}
.plus{background:#dcfce7;color:var(--success)}
.minus{background:#fee2e2;color:var(--danger)}
.zero{background:#f1f5f9;color:var(--neutral)}

input[type=number]{width:80px;border:1px solid #ddd;text-align:center}
input[type=number]:focus{border-color:var(--primary);outline:none;box-shadow:0 0 0 2px rgba(37,99,235,0.2)}

#reader{width:100%;max-width:400px;margin-top:10px;border-radius:8px;overflow:hidden}

/* Toast Notification */
#toast{position:fixed;bottom:20px;right:20px;background:#333;color:#fff;padding:12px 20px;border-radius:8px;
opacity:0;transition:opacity 0.3s;z-index:9999}
#toast.show{opacity:1}

/* Utility */
.text-right{text-align:right}
.found-highlight{background:#e0f2fe !important}
</style>
</head>

<body>

<header>
<h2>üì¶ Stock Opname Sparepart</h2>
<div style="font-size:12px;color:var(--neutral)">v2.0 Enhanced</div>
</header>

<div class="container">
<div class="card">

<div class="controls">
<input type="date" id="tanggal" style="max-width:160px">
<input type="file" id="fileInput" accept=".xlsx,.xls">
</div>

<div class="controls">
<input type="text" id="search" placeholder="Cari Part / Deskripsi..." style="flex-grow:1" oninput="filterTable()">
<button id="btnScan" onclick="toggleScan()">üì∑ Scan</button>
<button id="btnStopScan" class="danger" onclick="stopScan()" style="display:none">‚úñ Stop Scan</button>
<button class="danger" onclick="clearAll()">üóë Hapus Data</button>
</div>

<!-- Camera Preview -->
<div id="reader" style="display:none"></div>

<br>

<div class="table-wrapper">
<table>
<thead>
<tr>
<th style="width:40px">No</th>
<th>Part Number</th>
<th>Deskripsi</th>
<th style="width:80px">Qty System</th>
<th style="width:100px">Fisik</th>
<th style="width:100px">Selisih</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<br>
<div class="controls" style="justify-content:flex-end">
<button onclick="exportExcel()">‚¨á Download Excel</button>
<button class="primary" onclick="exportPDF()">‚¨á Download PDF</button>
</div>

</div>
</div>

<!-- Toast Element -->
<div id="toast">Notifikasi</div>

<script>
const tbody = document.getElementById("tbody");
const storageKey = "opnameData";
let html5QrCode = null;
let isScanning = false;

/* ===== INIT ===== */
window.onload = () => {
    document.getElementById("tanggal").value = localStorage.getItem("tanggal") || new Date().toISOString().split("T")[0];
    loadStorage();
}

/* ===== EXCEL UPLOAD ===== */
document.getElementById("fileInput").addEventListener("change", e => {
    const reader = new FileReader();
    reader.onload = ev => {
        try {
            const wb = XLSX.read(new Uint8Array(ev.target.result), { type: "array" });
            const sh = wb.Sheets[wb.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sh, { header: 1 });
            
            tbody.innerHTML = "";
            // Skip header (slice 1), map columns [Part, Desc, Qty]
            // Asumsi format Excel: Kolom A=No, B=Part, C=Desc, D=Qty (sesuaikan jika perlu)
            let count = 0;
            rows.slice(1).forEach((r, i) => {
                // Cek jika baris kosong
                if(!r[1] && !r[2]) return;
                
                // Deteksi otomatis kolom (sederhana)
                let part = r[1] || r[0]; // Jika kolom pertama adalah part
                let desc = r[2] || r[1];
                let qty = r[3] || r[2] || 0;
                
                // Jika header tidak jelas, coba deteksi angka untuk qty
                if(isNaN(parseInt(qty)) && !isNaN(parseInt(r[1]))) qty = r[1]; 
                
                addRow(i + 1, part, desc, parseInt(qty) || 0, 0);
                count++;
            });
            
            saveStorage();
            showToast(`‚úÖ Berhasil memuat ${count} item`);
        } catch (err) {
            showToast("‚ùå Gagal membaca file Excel");
            console.error(err);
        }
    };
    reader.readAsArrayBuffer(e.target.files[0]);
});

/* ===== ADD ROW ===== */
function addRow(no, part, desc, qty, fisik) {
    const tr = document.createElement("tr");
    // Replace undefined/null with empty string
    part = part || "";
    desc = desc || "";
    
    tr.innerHTML = `
    <td>${no}</td>
    <td class="part-cell">${part}</td>
    <td>${desc}</td>
    <td class="qty text-right">${qty}</td>
    <td class="text-right"><input type="number" value="${fisik}" oninput="calc(this)" onclick="this.select()"></td>
    <td class="selih-container text-right"><span class="selih zero">0</span></td>`;
    tbody.appendChild(tr);
    calc(tr.querySelector("input"));
}

/* ===== HITUNG SELISIH ===== */
function calc(input) {
    const row = input.closest("tr");
    const qty = parseInt(row.querySelector(".qty").innerText) || 0;
    const fisik = parseInt(input.value) || 0;
    const selisih = fisik - qty;
    
    const el = row.querySelector(".selih");
    el.innerText = (selisih > 0 ? "+" : "") + selisih;
    
    // Reset class
    el.className = "selih " + (selisih > 0 ? "plus" : selisih < 0 ? "minus" : "zero");
    
    saveStorage();
}

/* ===== SEARCH & FILTER ===== */
function filterTable() {
    const keyword = document.getElementById("search").value.toLowerCase();
    let visibleCount = 0;
    let lastVisibleRow = null;

    tbody.querySelectorAll("tr").forEach(r => {
        const part = r.cells[1].innerText.toLowerCase();
        const desc = r.cells[2].innerText.toLowerCase();
        const isMatch = part.includes(keyword) || desc.includes(keyword);
        
        r.style.display = isMatch ? "" : "none";
        
        // Highlight logika
        r.classList.remove("found-highlight");
        if(isMatch && keyword.length > 0){
            visibleCount++;
            lastVisibleRow = r;
        }
    });

    // UX: Jika hanya 1 hasil, auto focus ke input fisik
    if(visibleCount === 1 && lastVisibleRow) {
        lastVisibleRow.classList.add("found-highlight");
        lastVisibleRow.querySelector("input").focus();
    }
}

/* ===== BARCODE SCANNING ===== */
function toggleScan(){
    if(isScanning) return;
    
    const readerDiv = document.getElementById("reader");
    readerDiv.style.display = "block";
    
    html5QrCode = new Html5Qrcode("reader");
    
    const config = { fps: 10, qrbox: { width: 250, height: 250 } };
    
    html5QrCode.start(
        { facingMode: "environment" }, 
        config,
        onScanSuccess,
        onScanFailure
    ).then(() => {
        isScanning = true;
        document.getElementById("btnScan").style.display = "none";
        document.getElementById("btnStopScan").style.display = "inline-block";
    }).catch(err => {
        showToast("‚ùå Tidak bisa mengakses kamera");
        console.error(err);
        readerDiv.style.display = "none";
    });
}

function onScanSuccess(decodedText) {
    // Isi search box & filter
    document.getElementById("search").value = decodedText;
    filterTable();
    
    // Cek apakah ketemu
    const visibleRows = [...tbody.querySelectorAll("tr")].filter(r => r.style.display !== "none");
    
    if(visibleRows.length === 1){
        // Ketemu 1, stop scan & focus input
        stopScan();
        visibleRows[0].classList.add("found-highlight");
        visibleRows[0].querySelector("input").focus();
        showToast("‚úÖ Part ditemukan!");
        
        // Vibrate feedback jika didukung
        if(navigator.vibrate) navigator.vibrate(200);
    } else {
        showToast(`‚ö†Ô∏è Ditemukan ${visibleRows.length} part. Perjelas pencarian.`);
    }
}

function onScanFailure(error) {
    // Ignore error biasa (scan frame kosong)
}

function stopScan() {
    if(html5QrCode && isScanning) {
        html5QrCode.stop().then(() => {
            document.getElementById("reader").style.display = "none";
            document.getElementById("btnScan").style.display = "inline-block";
            document.getElementById("btnStopScan").style.display = "none";
            isScanning = false;
        }).catch(err => console.error(err));
    }
}

/* ===== STORAGE ===== */
function saveStorage() {
    const data = [];
    tbody.querySelectorAll("tr").forEach(r => {
        data.push({
            part: r.cells[1].innerText,
            desc: r.cells[2].innerText,
            qty: r.cells[3].innerText,
            fisik: r.cells[4].querySelector("input").value
        });
    });
    localStorage.setItem(storageKey, JSON.stringify(data));
    localStorage.setItem("tanggal", document.getElementById("tanggal").value);
}

function loadStorage() {
    const data = JSON.parse(localStorage.getItem(storageKey) || "[]");
    tbody.innerHTML = "";
    if(data.length > 0) {
        data.forEach((d, i) => addRow(i + 1, d.part, d.desc, d.qty, d.fisik));
    }
}

function clearAll() {
    if(confirm("Yakin ingin menghapus semua data opname?")) {
        localStorage.removeItem(storageKey);
        localStorage.removeItem("tanggal");
        location.reload();
    }
}

/* ===== EXPORT EXCEL ===== */
function exportExcel() {
    if(tbody.rows.length === 0) return showToast("Data kosong!");
    
    const data = [["Tanggal", document.getElementById("tanggal").value]];
    data.push(["No", "Part Number", "Deskripsi", "Qty System", "Fisik", "Selisih", "Keterangan"]);
    
    tbody.querySelectorAll("tr").forEach(r => {
        const s = parseInt(r.querySelector(".selih").innerText);
        let ket = "OK";
        if(s > 0) ket = "Lebih";
        if(s < 0) ket = "Kurang";
        
        data.push([
            r.cells[0].innerText,
            r.cells[1].innerText,
            r.cells[2].innerText,
            r.cells[3].innerText,
            r.cells[4].querySelector("input").value,
            r.querySelector(".selih").innerText,
            ket
        ]);
    });

    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Opname");
    XLSX.writeFile(wb, `Opname-${document.getElementById("tanggal").value}.xlsx`);
}

/* ===== EXPORT PDF ===== */
function exportPDF() {
    if(tbody.rows.length === 0) return showToast("Data kosong!");
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4'); // Landscape
    
    doc.setFontSize(16);
    doc.text("Stock Opname Sparepart", 14, 15);
    doc.setFontSize(10);
    doc.text("Tanggal : " + document.getElementById("tanggal").value, 14, 22);
    
    const rows = [];
    tbody.querySelectorAll("tr").forEach(r => {
        rows.push([
            r.cells[0].innerText,
            r.cells[1].innerText,
            r.cells[2].innerText.substring(0, 30), // Batasi deskripsi
            r.cells[3].innerText,
            r.cells[4].querySelector("input").value,
            r.querySelector(".selih").innerText
        ]);
    });

    doc.autoTable({
        startY: 26,
        head: [["No", "Part", "Deskripsi", "Qty", "Fisik", "Selisih"]],
        body: rows,
        styles: { fontSize: 8, cellPadding: 2 },
        headStyles: { fillColor: [37, 99, 235] }
    });
    
    doc.save(`Opname-${document.getElementById("tanggal").value}.pdf`);
}

/* ===== TOAST ===== */
function showToast(msg) {
    const t = document.getElementById("toast");
    t.innerText = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 3000);
}
</script>

</body>
</html>
